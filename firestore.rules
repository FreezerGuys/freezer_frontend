rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check admin role
    function isAdmin() {
      return request.auth.token.role == 'admin' || 
             request.auth.token.role == 'superadmin';
    }
    
    function isSuperAdmin() {
      return request.auth.token.role == 'superadmin';
    }

    // Helper function to validate location object (3x2 track system)
    function isValidLocation(location) {
      return location != null &&
        location.track != null &&
        location.position != null &&
        location.label != null &&
        location.description != null &&
        location.track >= 1 &&
        location.track <= 3 &&
        location.position >= 1 &&
        location.position <= 2;
    }

    // Helper function to validate category (4C or -20C)
    function isValidCategory(category) {
      return category == '4C' || category == '-20C';
    }

    // Helper function to validate status
    function isValidStatus(status) {
      return status == 'active' || status == 'expired' || 
             status == 'archived' || status == 'removed';
    }
    
    // Inventory collection - main items storage
    match /Inventory/{itemId} {
      // Read: all authenticated users can view
      allow read: if request.auth != null;
      
      // Create: only admin and superadmin
      allow create: if request.auth != null &&
        isAdmin() &&
        // Required fields validation
        request.resource.data.name != null &&
        request.resource.data.name is string &&
        request.resource.data.company != null &&
        request.resource.data.company is string &&
        request.resource.data.volume != null &&
        request.resource.data.volume is string &&
        request.resource.data.quantity != null &&
        request.resource.data.quantity is number &&
        request.resource.data.quantity >= 0 &&
        request.resource.data.category != null &&
        isValidCategory(request.resource.data.category) &&
        request.resource.data.barcode != null &&
        request.resource.data.barcode is string &&
        request.resource.data.qrCode != null &&
        request.resource.data.qrCode is string &&
        request.resource.data.status != null &&
        isValidStatus(request.resource.data.status) &&
        request.resource.data.createdAt != null &&
        request.resource.data.createdBy != null &&
        request.resource.data.createdBy is string &&
        request.resource.data.updatedAt != null &&
        // Location validation (required if present)
        (request.resource.data.location == null || 
         isValidLocation(request.resource.data.location)) &&
        // locationLabel should match location.label
        (request.resource.data.location == null ||
         request.resource.data.locationLabel == request.resource.data.location.label);
      
      // Update: only admin and superadmin
      allow update: if request.auth != null && 
        isAdmin() &&
        // Validate location if it's being updated
        ((!('location' in request.resource.data)) ||
         request.resource.data.location == null ||
         isValidLocation(request.resource.data.location)) &&
        // Keep locationLabel in sync with location
        ((!('location' in request.resource.data)) ||
         request.resource.data.location == null ||
         request.resource.data.locationLabel == request.resource.data.location.label);
      
      // Delete: only superadmin
      allow delete: if request.auth != null && isSuperAdmin();
      
      // Edit history subcollection - track user item changes only
      match /history/{changeId} {
        // Read: all authenticated users
        allow read: if request.auth != null;
        
        // Create/Update: user can log their own changes
        allow create, update: if request.auth != null &&
          request.resource.data.changedBy == request.auth.uid &&
          request.resource.data.action != null &&
          (request.resource.data.action == 'create' || 
           request.resource.data.action == 'update' || 
           request.resource.data.action == 'delete') &&
          request.resource.data.changedAt != null &&
          request.resource.data.changes != null;
      }
    }
    
    // Admin Audit Log - track all admin mutations
    match /AdminAuditLog/{logId} {
      // Read: only superadmin
      allow read: if request.auth != null && isSuperAdmin();
      
      // Create: backend only (via Cloud Functions)
      allow create: if false;
      
      // Update/Delete: never
      allow update, delete: if false;
    }
    
    // Checkouts collection - track item borrowing
    match /Checkouts/{checkoutId} {
      // Read: all authenticated users
      allow read: if request.auth != null;
      
      // Create: admin, superadmin, or the user checking out
      allow create: if request.auth != null &&
        (isAdmin() ||
         request.resource.data.userId == request.auth.uid) &&
        request.resource.data.inventoryId != null &&
        request.resource.data.userId != null &&
        request.resource.data.userId is string &&
        request.resource.data.checkedOutAt != null &&
        request.resource.data.quantity != null &&
        request.resource.data.quantity is number &&
        request.resource.data.quantity > 0 &&
        request.resource.data.expectedReturnDate != null &&
        request.resource.data.status != null &&
        (request.resource.data.status == 'active' ||
         request.resource.data.status == 'returned' ||
         request.resource.data.status == 'overdue' ||
         request.resource.data.status == 'lost');
      
      // Update: user can update their own checkouts, admin can update all
      allow update: if request.auth != null &&
        (isAdmin() ||
         resource.data.userId == request.auth.uid) &&
        // Validate status if being updated
        ((!('status' in request.resource.data)) ||
         request.resource.data.status == 'active' ||
         request.resource.data.status == 'returned' ||
         request.resource.data.status == 'overdue' ||
         request.resource.data.status == 'lost');
      
      // Delete: only superadmin
      allow delete: if request.auth != null && isSuperAdmin();
    }
    
    // Users collection - user account info
    match /Users/{userId} {
      // Read: self or admin/superadmin
      allow read: if request.auth != null &&
        (request.auth.uid == userId ||
         isAdmin());
      
      // Create: allow to create own user doc during auth
      allow create: if request.auth != null &&
        request.auth.uid == userId &&
        request.resource.data.uid == userId;
      
      // Update: self or admin/superadmin
      allow update: if request.auth != null &&
        (request.auth.uid == userId ||
         isAdmin());
      
      // Delete: never allow (soft delete only)
      allow delete: if false;
    }
  }
}
